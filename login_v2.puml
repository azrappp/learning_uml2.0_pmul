@startuml
mainframe **sd** Login
hide footbox

actor "**: User**" as User
boundary "**: LoginForm**" as LoginForm
control "**: AuthController **" as AuthController
control "**: better-auth **" as BetterAuthService
entity  "**: User **" as PrismaAdapter
control "**: SessionController**" as SessionService

' --- Start of main flow ---
User -> LoginForm : submitLogin(email, password)
activate LoginForm

LoginForm -> LoginForm : validateForm(email, password)
activate LoginForm
deactivate LoginForm

opt fields empty
    LoginForm -> LoginForm : Error "Fields cannot be empty")
    activate LoginForm
    deactivate LoginForm
end

' Client calls server
LoginForm -> AuthController : submitCredentials(email, password)
activate AuthController

AuthController -> BetterAuthService : verifyCredentials(email, password)
activate BetterAuthService

BetterAuthService -> PrismaAdapter : findUserByEmail(email)
activate PrismaAdapter
PrismaAdapter --> BetterAuthService : userData or null
deactivate PrismaAdapter

alt user not found
    BetterAuthService --> AuthController : Failed "user not found"
    AuthController --> LoginForm : Error "Invalid email or password" 
    LoginForm -> LoginForm : displayError("Invalid email or password")
    activate LoginForm
    deactivate LoginForm

else user found
    BetterAuthService -> BetterAuthService : verifyPassword(password, userData.passwordHash)
    activate BetterAuthService
    alt password mismatch
        BetterAuthService --> AuthController : Failed "bad credentials"
        deactivate BetterAuthService
        AuthController --> LoginForm : Error "Invalid email or password"
        LoginForm -> LoginForm : displayError("Invalid email or password")
        activate LoginForm
        deactivate LoginForm

    else password match
        BetterAuthService -> SessionService : createSession(userData)
        activate SessionService
        SessionService --> BetterAuthService : session token
        deactivate SessionService

        BetterAuthService --> AuthController : session
        deactivate BetterAuthService

        AuthController --> LoginForm : session
        deactivate AuthController
        LoginForm -> LoginForm : redirect("/dashboard")
        activate LoginForm
        deactivate LoginForm
    end
end

@enduml
